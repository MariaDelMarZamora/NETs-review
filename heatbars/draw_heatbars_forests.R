rm(list=ls())
#==== USER SECTION ==========
u_sheetName <- "BECCS (so far only bioenergy potential)"
u_sheetName <- "Afforestation and Reforestation"
#u_sheetName <- "DAC"
#u_sheetName <- "BECCS (Bioenergy)"
DEBUG       <- TRUE

#==== INITIALISE ==========
# Load libraries
library(googlesheets)
library(dplyr)
library(tidyr)
library(ggplot2)

source("heatbars/heatbar_functions.R")

# Authorise googlesheets to access your Google Sheets account
gs_auth()


#==== READ IN SPREADSHEET ==========
gs  <- gs_title("Copy of NETs Review")
ss  <- gs_read(gs, ws = u_sheetName, verbose=DEBUG)

data <- get_data(ss)

################################################
## Generate a new df of ranges

# Adjust the maximum here to change the scale
ranges <- seq(1,300)
df <- data.frame(v=ranges)


# Get a list of resources, or define it yourself
resources <- unique(
  data[data$measurement=="max" & data$variable!="cost",]$variable
)
resources <- resources[!is.na(resources)]


costs <- unique(
  data[data$measurement=="max" & 
         data$variable=="cost",
       ]$variable
)




# Count the studies with a maximum under each range for each resource
# Add any additional "Dimension" filters too
res2050 <- countranges(df, filter(data), costs, "max")
heatbar(res2050,"pcnt") + 
  labs(x="Variable",y="Cost")
ggsave("plots/heatbars/afforestation/max.png",width=8,height=5)

res2050 <- countranges(df, filter(data), costs, "min")
heatbar(res2050,"pcnt") + 
  labs(x="Variable",y="Cost") +
  ylim(c(0,200))
ggsave("plots/heatbars/afforestation/min.png",width=8,height=5)


res2050 <- countranges(df, filter(data, PY > 2004), costs, "range")
heatbar(res2050,"pcnt") + 
  labs(x="Variable",y="Cost")
ggsave("plots/heatbars/afforestation/max_gt_2004.png",width=8,height=5)

res2050 <- countranges(df, filter(data, PY > 2004), costs, "min")

heatbar(res2050,"pcnt") + 
  labs(x="Variable",y="Cost") +
  ylim(c(0,200))

ggsave("plots/heatbars/afforestation/min_gt_2004.png",width=8,height=5)

### Range
res2050 <- countranges(df, filter(data, PY > 2004), costs, "range")

heatbar(res2050,"pcnt") + 
  labs(x="Variable",y="Cost") +
  ylim(c(0,200))


ggsave("plots/heatbars/afforestation/range_gt_2004.png",width=8,height=5)

res2050 <- countranges(df, filter(data), costs, "range")

heatbar(res2050,"pcnt") + 
  labs(x="Variable",y="Cost") #+
  #ylim(c(0,200))

ggsave("plots/heatbars/afforestation/range.png",width=8,height=5)



dataf <- filter(
  suppressWarnings(mutate(data,value=as.numeric(value))),
  measurement %in% c("min","max"),
  variable==costs[1],
  !is.na(value)
) %>% spread(
  measurement, value
) %>%
  group_by(PY) %>%
  mutate(
    gtot = n(),
    pn = row_number()
  ) %>%
  ungroup() %>%
  mutate(
    PY = as.numeric(PY),
    jitter= (1/gtot)*(pn-1),
    PYJ = PY + (1/gtot)*(pn-1)
  )



w = 20
y = 1980
f <- "pcnt"
df <- res2050[res2050[[f]]>0,]
flab <- if (f=="pcnt") "% of Studies" else "Number of Studies" 
ggplot() +
  theme_bw() +
  geom_bar(
    data=df,
    aes_string(x=y,y=1,fill=f),
    stat="identity",
    width=w,
    color=NA
  ) +
  geom_bar(
    data=df,
    aes(x=y),
    fill=NA,
    color="grey22",
    width=w
  ) +
  scale_fill_gradientn(
    colours=c(NA,"#fffcef","#fcf0ba","#d30000"),
    values = scales::rescale(c(0,min(df[[f]]),max(df[[f]])/2,max(df[[f]]))),
    name=flab
  ) +
  scale_x_continuous(
    breaks = c(1990,2000,2010)
  ) +
  guides(fill = guide_colourbar(reverse = TRUE)) +
  geom_linerange(
    data=dataf,
    aes(x=PYJ,ymin=min,ymax=max)
  ) + labs(
    x = "Year",y="Costs in $US(2011)/tCO2"
  )


ggsave("plots/heatbars/afforestation/ranges_years.png",width=8,height=5)



